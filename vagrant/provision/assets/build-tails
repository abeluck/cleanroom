#!/bin/sh

set -e

as_root_do() {
	sudo \
		RSYNC_PROXY="$RSYNC_PROXY" \
		http_proxy="$http_proxy" \
		https_proxy="$https_proxy" \
		ftp_proxy="$ftp_proxy" \
		no_proxy="$no_proxy" \
		"$@"
}

REV="${1:-$(git --git-dir=/amnesia.git name-rev --name-only HEAD)}"
COMMIT="$(git --git-dir=/amnesia.git rev-parse --verify "$REV")"

cd /home/vagrant

test -d amnesia || git clone /amnesia.git amnesia

cd amnesia

git fetch origin
as_root_do git checkout --force "$REV"
as_root_do git reset --hard "$COMMIT"
as_root_do lb clean || true
as_root_do lb config
as_root_do lb build
